# Use LLM to evaluate contract against contract matrix

## Background

I'm developing an AI-powered contract review application.
Existing tools for LLM: `google_docs_tools/tools.py`.
Contract approval matrix: `contract_approval_matrix.json`
Flow:

1. LLM receives a Google Docs URL from user (the sales contract sent by customer)
2. Use tools to read the content
3. Use reasoning to identify contract terms that violate contractual policies of the supplier, based on contract approval
4. Use reasoning to identify the person to escalate for approval, based on contract approval matrix
5. Use tools to add comment to Google Docs contract
6. Use tools to highlight policy violation terms in Google Docs contract
7. Return a summary to user

## 1st requirement for you now

1. Implement a simple Python script that can be executed by a FastAPI endpoint
2. FastAPI is for frontend chatbot-ui to integrate
3. FastAPI will be implemented soon, not now
4. Right now, just a simple Python script to invoke LLM to read the contract, check againts approval matrix, add comments and highlight texts in Google Docs contract, return a summary to user
5. Summary can look like this for example

    ```TEXT
    {High-level summary generated by AI. Max 2 sentences}

    <h2>Contract terms deviations from policies</h2>
    {State how many terms are violating policies}

    {State the highest level of escalation, the role required to approves/decides}

    {Suggest user to visit Google Docs for more details}
    ```

6. Escalation level: Head of BU < BA President < CEO
7. Use Claude Sonnet 4.5 through AWS Bedrock
8. For now, the Google Docs URL is inside the tools. Later on, the Google Docs URL will be provided as parameter. To be done later.

### Improvement to text highlight

I see the comments and yellow highlights now.

However, for one of the violation, instead of highlighting this "if the PURCHASER so demands, a sum of 20% per cent of the CONTRACT PRICE as liquidated damages for each commencing day of the delay", it highlighted this: "If the equipment included in the DELIVERY are not ready for shipment at SUPPLIER's".

Requirements/improvements:

1. Highlight the targeted texts that was identified to directly violate the policies, not highlighting the starting texts of that paragraph
2. Highlight different colors depending on the escalation.
   1. Head of BU: Yellow
   2. BA President: Orange
   3. CEO: Red
3. In the comment, below '[Re: ...]', add a line '{Role} approval required'

### Improvement to repsonse to user after evaluation is done

1. Remove Violations Summary

## 2nd requirement

Create a FastAPI with the endpoint below:

```PYTHON
# Streaming chat endpoint
@app.post("/chat/stream")
async def chat_stream(request: ChatInput):
    try:
        messages = [{"role": "user", "content": request.message}]

        def generate_response():
            for chunk in assistant.stream_agent(messages):
                yield chunk

        return StreamingResponse(generate_response(), media_type="text/plain")
    except Exception as e:
        return {"response": f"Error: {str(e)}"}
```

This endpoint receives user's message, pass to the current python script for evaluating contract.
In user message, user will provide Google Docs url (the contract) that needs to be evaluated.

You need to improve the current Python script to make the LLM read user's message, pick out the Google Docs URL, feed to tools for next steps in the evaluation process.

## 3rd requirement

1. I defined the previous contracts here: `previous-contracts.json`.
2. I want the current LLM-powered contract evaluator to consider this during the evaluation.
3. LLM should add to the response to user, below the "Highest level escalation required" section, a section 'My recommendations'
4. In this section, LLM should suggest either:
   1. Due to high level escalation required and for this customer, no deviation has been accepted before, and high number of past negotiation rounds, suggest to re-negotiate with customer before escalating
   2. Even though escalation level is high, for this customer, deviations have been accepted before, with less number of negotiation rounds, suggest to escalate directly instead of re-negotiating

